# æš‚æ—¶ç¦ç”¨åŽŸrelease workflowï¼Œä½¿ç”¨simple-release.yml
name: Build and Release (Disabled)

on:
  # push:
  #   tags:
  #     - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-amd64
            goos: windows
            goarch: amd64
            ext: .exe
            name: ytb2bili-windows-amd64
          - os: linux-amd64
            goos: linux
            goarch: amd64
            ext: ""
            name: ytb2bili-linux-amd64
          - os: linux-arm64
            goos: linux
            goarch: arm64
            ext: ""
            name: ytb2bili-linux-arm64
          - os: darwin-amd64
            goos: darwin
            goarch: amd64
            ext: ""
            name: ytb2bili-darwin-amd64
          - os: darwin-arm64
            goos: darwin
            goarch: arm64
            ext: ""
            name: ytb2bili-darwin-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Cache Node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Check for frontend build
      run: |
        echo "Checking for frontend build support..."
        if [ -f "Makefile" ] && grep -q "build-web" Makefile; then
          echo "âœ… Found Makefile with build-web target"
          echo "HAS_FRONTEND=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ No frontend build configuration found"
          echo "HAS_FRONTEND=false" >> $GITHUB_ENV
        fi
        
    - name: Build frontend (conditional)
      if: env.HAS_FRONTEND == 'true'
      run: |
        echo "ðŸ”¨ Building frontend..."
        make build-web || echo "âš ï¸ Frontend build failed, continuing without frontend"

    - name: Download Go dependencies
      run: go mod download

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        LDFLAGS="-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S')"
        go build -ldflags="$LDFLAGS" -o ${{ matrix.name }}${{ matrix.ext }} .

    - name: Create config example
      run: |
        mkdir -p release
        cp ${{ matrix.name }}${{ matrix.ext }} release/
        cp config.toml.example release/config.toml
        cp README.md release/
        
        # Create startup script for different platforms
        if [ "${{ matrix.goos }}" = "windows" ]; then
          cat > release/start.bat << 'EOF'
        @echo off
        echo Starting YTB2BILI Server...
        ytb2bili-windows-amd64.exe
        pause
        EOF
        else
          cat > release/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting YTB2BILI Server..."
        chmod +x ./ytb2bili-*
        ./ytb2bili-*
        EOF
          chmod +x release/start.sh
        fi

    - name: Create archive
      run: |
        cd release
        if [ "${{ matrix.goos }}" = "windows" ]; then
          # ä½¿ç”¨ zip å‘½ä»¤åˆ›å»º Windows åŽ‹ç¼©åŒ…
          zip -r ../${{ matrix.name }}.zip *
          # åˆ›å»ºç©ºçš„ tar.gz æ–‡ä»¶ä»¥é¿å…ä¸Šä¼ é”™è¯¯
          touch ../${{ matrix.name }}.tar.gz
        else
          # åˆ›å»º Linux/macOS åŽ‹ç¼©åŒ…
          tar -czf ../${{ matrix.name }}.tar.gz *
          # åˆ›å»ºç©ºçš„ zip æ–‡ä»¶ä»¥é¿å…ä¸Šä¼ é”™è¯¯
          touch ../${{ matrix.name }}.zip
        fi
        cd ..
        ls -la ${{ matrix.name }}.*

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}.*
        retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List downloaded artifacts
      run: |
        echo "ðŸ“ Downloaded artifacts structure:"
        find artifacts -type f -name "*.zip" -o -name "*.tar.gz" | head -20
        ls -la artifacts/*/

    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        echo "## ðŸŽ‰ Release ${{ steps.version.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“¦ ä¸‹è½½é“¾æŽ¥" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "| å¹³å° | æž¶æž„ | ä¸‹è½½é“¾æŽ¥ |" >> CHANGELOG.md
        echo "|------|------|----------|" >> CHANGELOG.md
        echo "| Windows | x64 | [ytb2bili-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ytb2bili-windows-amd64.zip) |" >> CHANGELOG.md
        echo "| Linux | x64 | [ytb2bili-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ytb2bili-linux-amd64.tar.gz) |" >> CHANGELOG.md
        echo "| Linux | ARM64 | [ytb2bili-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ytb2bili-linux-arm64.tar.gz) |" >> CHANGELOG.md
        echo "| macOS | Intel | [ytb2bili-darwin-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ytb2bili-darwin-amd64.tar.gz) |" >> CHANGELOG.md
        echo "| macOS | Apple Silicon | [ytb2bili-darwin-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ytb2bili-darwin-arm64.tar.gz) |" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸš€ å¿«é€Ÿå¼€å§‹" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…" >> CHANGELOG.md
        echo "2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•" >> CHANGELOG.md
        echo "3. ç¼–è¾‘ \`config.toml\` é…ç½®æ–‡ä»¶" >> CHANGELOG.md
        echo "4. è¿è¡Œ \`start.sh\` (Linux/macOS) æˆ– \`start.bat\` (Windows)" >> CHANGELOG.md
        echo "5. è®¿é—® http://localhost:8096" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“‹ ç³»ç»Ÿè¦æ±‚" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- æ“ä½œç³»ç»Ÿ: Windows 10+, Linux (Ubuntu 18.04+), macOS 10.15+" >> CHANGELOG.md
        echo "- å†…å­˜: å»ºè®® 4GB+ (ç”¨äºŽè§†é¢‘å¤„ç†)" >> CHANGELOG.md
        echo "- ç£ç›˜: å»ºè®® 10GB+ å¯ç”¨ç©ºé—´ (ç”¨äºŽè§†é¢‘å­˜å‚¨)" >> CHANGELOG.md
        echo "- ç½‘ç»œ: ç¨³å®šçš„äº’è”ç½‘è¿žæŽ¥" >> CHANGELOG.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
        files: |
          artifacts/ytb2bili-windows-amd64/ytb2bili-windows-amd64.zip
          artifacts/ytb2bili-linux-amd64/ytb2bili-linux-amd64.tar.gz
          artifacts/ytb2bili-linux-arm64/ytb2bili-linux-arm64.tar.gz
          artifacts/ytb2bili-darwin-amd64/ytb2bili-darwin-amd64.tar.gz
          artifacts/ytb2bili-darwin-arm64/ytb2bili-darwin-arm64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰: è‡ªåŠ¨æž„å»º Docker é•œåƒ (éœ€è¦é…ç½® DOCKERHUB_USERNAME å’Œ DOCKERHUB_TOKEN secrets)
  # æš‚æ—¶ç¦ç”¨Dockeræž„å»ºï¼Œä¸“æ³¨äºŽäºŒè¿›åˆ¶æ–‡ä»¶å‘å¸ƒ
  docker:
    name: Build Docker Image
    needs: build
    runs-on: ubuntu-latest
    # æš‚æ—¶ç¦ç”¨: if: false
    if: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
      id: docker-login

    - name: Build Docker image (local test)
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: false
        tags: |
          ytb2bili:${{ steps.version.outputs.version }}
          ytb2bili:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Docker image to Hub
      uses: docker/build-push-action@v5
      if: steps.docker-login.outcome == 'success'
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/ytb2bili:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/ytb2bili:${{ steps.version.outputs.version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max